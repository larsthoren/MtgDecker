@page "/admin/logs"
@inject MtgDecker.Web.Services.InMemoryLogStore LogStore
@implements IDisposable

<PageTitle>Logs - MtgDecker</PageTitle>

<MudStack Row="true" Class="mb-4" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
    <MudText Typo="Typo.h4">Application Logs</MudText>
    <MudStack Row="true" Spacing="2">
        <MudSelect @bind-Value="_minLevel" Label="Min Level" Variant="Variant.Outlined"
                   Style="width: 160px;" Dense="true">
            <MudSelectItem Value="LogLevel.Information">Info</MudSelectItem>
            <MudSelectItem Value="LogLevel.Warning">Warning</MudSelectItem>
            <MudSelectItem Value="LogLevel.Error">Error</MudSelectItem>
        </MudSelect>
        <MudTextField @bind-Value="_filter" Label="Filter" Variant="Variant.Outlined"
                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.FilterList"
                      Style="width: 250px;" Margin="Margin.Dense" Immediate="true" />
        <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Primary"
                       Variant="Variant.Filled" OnClick="Refresh" />
        <MudIconButton Icon="@Icons.Material.Filled.DeleteSweep" Color="Color.Error"
                       Variant="Variant.Filled" OnClick="Clear" />
    </MudStack>
</MudStack>

<MudPaper Class="pa-0" Elevation="1" Style="max-height: 75vh; overflow-y: auto;">
    <MudSimpleTable Dense="true" Hover="true" FixedHeader="true" Style="white-space: nowrap;">
        <thead>
            <tr>
                <th style="width: 160px;">Time</th>
                <th style="width: 80px;">Level</th>
                <th style="width: 250px;">Category</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in FilteredEntries)
            {
                <tr style="@GetRowStyle(entry.Level)">
                    <td>@entry.Timestamp.ToString("HH:mm:ss.fff")</td>
                    <td>
                        <MudChip T="string" Size="Size.Small" Color="@GetLevelColor(entry.Level)">
                            @GetLevelLabel(entry.Level)
                        </MudChip>
                    </td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">
                        @ShortenCategory(entry.Category)
                    </td>
                    <td style="white-space: pre-wrap; max-width: 600px;">
                        @entry.Message
                        @if (entry.Exception != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error" Style="white-space: pre-wrap;">@entry.Exception</MudText>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </MudSimpleTable>
</MudPaper>

<MudText Typo="Typo.caption" Class="mt-2">
    Showing @FilteredEntries.Count of @_allEntries.Count entries
</MudText>

@code {
    private IReadOnlyList<MtgDecker.Web.Services.LogEntry> _allEntries = Array.Empty<MtgDecker.Web.Services.LogEntry>();
    private LogLevel _minLevel = LogLevel.Information;
    private string? _filter;

    private List<MtgDecker.Web.Services.LogEntry> FilteredEntries =>
        _allEntries
            .Where(e => e.Level >= _minLevel)
            .Where(e => string.IsNullOrEmpty(_filter)
                || e.Message.Contains(_filter, StringComparison.OrdinalIgnoreCase)
                || e.Category.Contains(_filter, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(e => e.Timestamp)
            .ToList();

    protected override void OnInitialized()
    {
        _allEntries = LogStore.GetEntries();
        LogStore.OnNewEntry += OnNewLogEntry;
    }

    private void OnNewLogEntry()
    {
        InvokeAsync(() =>
        {
            _allEntries = LogStore.GetEntries();
            StateHasChanged();
        });
    }

    private void Refresh()
    {
        _allEntries = LogStore.GetEntries();
    }

    private void Clear()
    {
        LogStore.Clear();
        _allEntries = LogStore.GetEntries();
    }

    public void Dispose()
    {
        LogStore.OnNewEntry -= OnNewLogEntry;
    }

    private static Color GetLevelColor(LogLevel level) => level switch
    {
        LogLevel.Warning => Color.Warning,
        LogLevel.Error => Color.Error,
        LogLevel.Critical => Color.Error,
        _ => Color.Default
    };

    private static string GetLevelLabel(LogLevel level) => level switch
    {
        LogLevel.Information => "INF",
        LogLevel.Warning => "WRN",
        LogLevel.Error => "ERR",
        LogLevel.Critical => "CRT",
        _ => level.ToString()[..3].ToUpperInvariant()
    };

    private static string GetRowStyle(LogLevel level) => level switch
    {
        LogLevel.Error or LogLevel.Critical => "background-color: rgba(244,67,54,0.1);",
        LogLevel.Warning => "background-color: rgba(255,152,0,0.08);",
        _ => ""
    };

    private static string ShortenCategory(string category)
    {
        var lastDot = category.LastIndexOf('.');
        return lastDot >= 0 ? category[(lastDot + 1)..] : category;
    }
}
