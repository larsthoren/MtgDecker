@using MtgDecker.Engine
@using MtgDecker.Engine.Enums
@namespace MtgDecker.Web.Components.Pages.Game

<div class="game-board" tabindex="0" @ref="_boardRef" @onkeydown="HandleKeyDown">
    @if (IsGameOver)
    {
        <div class="game-over-overlay">
            <MudPaper Class="pa-6 text-center" Elevation="8">
                <MudText Typo="Typo.h4" Class="mb-2">Game Over</MudText>
                @if (Winner != null)
                {
                    <MudText Typo="Typo.h5" Color="Color.Secondary">@Winner wins!</MudText>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4"
                           Href="/game/new">New Game</MudButton>
            </MudPaper>
        </div>
    }

    <div class="board-main">
        @* Opponent zone (top) *@
        <PlayerZone PlayerName="@OpponentPlayer.Name"
                    Battlefield="@OpponentPlayer.Battlefield.Cards"
                    Hand="@OpponentPlayer.Hand.Cards"
                    Graveyard="@OpponentPlayer.Graveyard.Cards"
                    Life="@OpponentPlayer.Life"
                    LibraryCount="@OpponentPlayer.Library.Count"
                    Exile="@OpponentPlayer.Exile.Cards"
                    ManaPool="@OpponentPlayer.ManaPool"
                    OnLifeAdjust="(delta) => OnLifeAdjust.InvokeAsync((OpponentSeat, delta))"
                    OnDrawCard="() => OnDrawCard.InvokeAsync(OpponentSeat)"
                    IsOpponent="true"
                    IsActivePlayer="@(State.ActivePlayer == OpponentPlayer)"
                    CanAct="@HasPriority"
                    PlayerId="@OpponentPlayer.Id"
                    OnAction="OnAction"
                    CombatState="@State.Combat" />

        @* Turn bar (middle) *@
        <MudPaper Class="turn-bar pa-2" Elevation="2">
            <div class="turn-bar-content">
                <MudText Typo="Typo.body2">
                    Turn @State.TurnNumber â€” @State.ActivePlayer.Name's turn
                </MudText>
                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@State.CurrentPhase</MudChip>
                @if (State.CurrentPhase == Phase.Combat && State.CombatStep != CombatStep.None)
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small">@FormatCombatStep(State.CombatStep)</MudChip>
                }
                @if (HasPriority)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Your Priority</MudChip>
                    <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="PassPriority">Pass Priority</MudButton>
                }
                else if (!IsWaitingForCombat)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">Waiting...</MudChip>
                }
                <MudSpacer />
                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Warning"
                           StartIcon="@Icons.Material.Filled.Undo"
                           Disabled="@(LocalPlayer.ActionHistory.Count == 0)"
                           OnClick="() => OnUndo.InvokeAsync()">Undo</MudButton>
                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error"
                           OnClick="() => OnSurrender.InvokeAsync()">Surrender</MudButton>
            </div>
        </MudPaper>

        @* Stack display (between turn bar and local player) *@
        <StackDisplay Stack="@State.Stack" />

        @* Local player zone (bottom) *@
        <PlayerZone PlayerName="@LocalPlayer.Name"
                    Battlefield="@LocalPlayer.Battlefield.Cards"
                    Hand="@LocalPlayer.Hand.Cards"
                    Graveyard="@LocalPlayer.Graveyard.Cards"
                    Life="@LocalPlayer.Life"
                    LibraryCount="@LocalPlayer.Library.Count"
                    Exile="@LocalPlayer.Exile.Cards"
                    ManaPool="@LocalPlayer.ManaPool"
                    OnLifeAdjust="(delta) => OnLifeAdjust.InvokeAsync((PlayerSeat, delta))"
                    OnDrawCard="() => OnDrawCard.InvokeAsync(PlayerSeat)"
                    IsOpponent="false"
                    IsActivePlayer="@(State.ActivePlayer == LocalPlayer)"
                    CanAct="@HasPriority"
                    PlayerId="@LocalPlayer.Id"
                    OnAction="OnAction"
                    IsWaitingForManaColor="@IsWaitingForManaColor"
                    ManaColorOptions="@ManaColorOptions"
                    OnManaColorChosen="HandleManaColorChosen"
                    IsWaitingForAttackers="@(IsLocalActive && Handler?.IsWaitingForAttackers == true)"
                    EligibleAttackers="@(IsLocalActive ? Handler?.EligibleAttackers : null)"
                    OnAttackersChosen="OnAttackersChosen"
                    CombatState="@State.Combat"
                    IsWaitingForBlockers="@(IsLocalDefending && Handler?.IsWaitingForBlockers == true)"
                    EligibleBlockers="@(IsLocalDefending ? Handler?.EligibleBlockers : null)"
                    CurrentAttackers="@(IsLocalDefending ? Handler?.CurrentAttackers : null)"
                    OnBlockersChosen="OnBlockersChosen"
                    IsWaitingForBlockerOrder="@(IsLocalActive && Handler?.IsWaitingForBlockerOrder == true)"
                    OrderingAttackerId="@(Handler?.OrderingAttackerId)"
                    BlockersToOrder="@(IsLocalActive ? Handler?.BlockersToOrder : null)"
                    OnBlockerOrderChosen="OnBlockerOrderChosen" />
    </div>

    @* Game log (right) *@
    <GameLogPanel GameLog="@State.GameLog" />
</div>

@code {
    [Parameter] public GameState State { get; set; } = default!;
    [Parameter] public int PlayerSeat { get; set; }
    [Parameter] public InteractiveDecisionHandler? Handler { get; set; }
    [Parameter] public EventCallback<GameAction> OnAction { get; set; }
    [Parameter] public EventCallback OnSurrender { get; set; }
    [Parameter] public EventCallback OnUndo { get; set; }
    [Parameter] public EventCallback<(int seat, int delta)> OnLifeAdjust { get; set; }
    [Parameter] public EventCallback<int> OnDrawCard { get; set; }
    [Parameter] public bool IsGameOver { get; set; }
    [Parameter] public string? Winner { get; set; }
    [Parameter] public EventCallback<ManaColor> OnManaColorChosen { get; set; }
    [Parameter] public EventCallback<IReadOnlyList<Guid>> OnAttackersChosen { get; set; }
    [Parameter] public EventCallback<Dictionary<Guid, Guid>> OnBlockersChosen { get; set; }
    [Parameter] public EventCallback<IReadOnlyList<Guid>> OnBlockerOrderChosen { get; set; }

    private ElementReference _boardRef;
    private Player LocalPlayer => PlayerSeat == 1 ? State.Player1 : State.Player2;
    private Player OpponentPlayer => PlayerSeat == 1 ? State.Player2 : State.Player1;
    private int OpponentSeat => PlayerSeat == 1 ? 2 : 1;
    private bool HasPriority => Handler?.IsWaitingForAction == true;
    private bool IsWaitingForManaColor => Handler?.IsWaitingForManaColor == true;
    private IReadOnlyList<ManaColor>? ManaColorOptions => Handler?.ManaColorOptions;
    private bool IsLocalActive => State.ActivePlayer == LocalPlayer;
    private bool IsLocalDefending => State.ActivePlayer == OpponentPlayer;
    private bool IsWaitingForCombat =>
        Handler?.IsWaitingForAttackers == true ||
        Handler?.IsWaitingForBlockers == true ||
        Handler?.IsWaitingForBlockerOrder == true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _boardRef.FocusAsync();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.CtrlKey && e.Key == "z" && LocalPlayer.ActionHistory.Count > 0)
        {
            await OnUndo.InvokeAsync();
        }
    }

    private async Task PassPriority()
    {
        await OnAction.InvokeAsync(GameAction.Pass(LocalPlayer.Id));
    }

    private async Task HandleManaColorChosen(ManaColor color)
    {
        await OnManaColorChosen.InvokeAsync(color);
    }

    private string FormatCombatStep(CombatStep step) => step switch
    {
        CombatStep.BeginCombat => "Begin Combat",
        CombatStep.DeclareAttackers => "Declare Attackers",
        CombatStep.DeclareBlockers => "Declare Blockers",
        CombatStep.CombatDamage => "Combat Damage",
        CombatStep.EndCombat => "End Combat",
        _ => ""
    };
}
