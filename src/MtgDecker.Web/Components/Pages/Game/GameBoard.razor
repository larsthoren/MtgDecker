@using MtgDecker.Engine
@using MtgDecker.Engine.Enums
@using MtgDecker.Engine.Mana
@namespace MtgDecker.Web.Components.Pages.Game

<div class="game-board" tabindex="0" @ref="_boardRef" @onkeydown="HandleKeyDown">
    @if (IsGameOver)
    {
        <div class="game-over-overlay">
            <MudPaper Class="pa-6 text-center" Elevation="8">
                <MudText Typo="Typo.h4" Class="mb-2">Game Over</MudText>
                @if (Winner != null)
                {
                    <MudText Typo="Typo.h5" Color="Color.Secondary">@Winner wins!</MudText>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4"
                           Href="/game/new">New Game</MudButton>
            </MudPaper>
        </div>
    }

    @* Row 1: Opponent info bar *@
    <div class="opponent-info-bar">
        <MudText Typo="Typo.subtitle2">@OpponentPlayer.Name</MudText>
        <MudChip T="string" Size="Size.Small" Color="Color.Error">@OpponentPlayer.Life HP</MudChip>
        <MudChip T="string" Size="Size.Small" Color="Color.Default">Hand: @OpponentPlayer.Hand.Cards.Count</MudChip>
        <MudChip T="string" Size="Size.Small" Color="Color.Default">Grave: @OpponentPlayer.Graveyard.Cards.Count</MudChip>
        <MudChip T="string" Size="Size.Small" Color="Color.Default">Exile: @OpponentPlayer.Exile.Cards.Count</MudChip>
        <MudChip T="string" Size="Size.Small" Color="Color.Default">Lib: @OpponentPlayer.Library.Count</MudChip>
        @if (OpponentPlayer.ManaPool?.Total > 0)
        {
            <div class="mana-pool-display">
                @foreach (var (color, symbol) in ManaSymbols)
                {
                    @if (OpponentPlayer.ManaPool[color] > 0)
                    {
                        <span class="mana-entry">
                            <img src="https://svgs.scryfall.io/card-symbols/@(symbol).svg"
                                 alt="@color" class="mana-symbol" />
                            <span class="mana-count">@OpponentPlayer.ManaPool[color]</span>
                        </span>
                    }
                }
            </div>
        }
        @if (State.ActivePlayer == OpponentPlayer)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Primary">Active</MudChip>
        }
    </div>

    @* Row 2: Opponent battlefield *@
    <div class="opponent-battlefield">
        <div class="battlefield-row lands-row">
            @foreach (var card in OpponentPlayer.Battlefield.Cards.Where(c => c.IsLand))
            {
                <CardDisplay Name="@card.Name"
                             ImageUrl="@card.ImageUrl"
                             Tapped="@card.IsTapped"
                             CardSize="90"
                             Clickable="@(Handler?.IsWaitingForTarget == true)"
                             IsAttacking="@(State.Combat?.Attackers.Contains(card.Id) == true)"
                             IsBlocking="@IsCardBlockingAnywhere(card.Id)"
                             Power="@card.Power"
                             Toughness="@card.Toughness"
                             DamageMarked="@card.DamageMarked"
                             OnClick="async () => await HandleOpponentCardClick(card)" />
            }
        </div>
        <div class="battlefield-row nonlands-row">
            @foreach (var card in OpponentPlayer.Battlefield.Cards.Where(c => !c.IsLand))
            {
                <CardDisplay Name="@card.Name"
                             ImageUrl="@card.ImageUrl"
                             Tapped="@card.IsTapped"
                             CardSize="90"
                             Clickable="@(Handler?.IsWaitingForTarget == true)"
                             IsAttacking="@(State.Combat?.Attackers.Contains(card.Id) == true)"
                             IsBlocking="@IsCardBlockingAnywhere(card.Id)"
                             Power="@card.Power"
                             Toughness="@card.Toughness"
                             DamageMarked="@card.DamageMarked"
                             OnClick="async () => await HandleOpponentCardClick(card)" />
            }
        </div>
        @if (OpponentPlayer.Battlefield.Cards.Count == 0)
        {
            <MudText Typo="Typo.caption" Class="empty-zone">Opponent Battlefield</MudText>
        }
    </div>

    @* Row 3: Phase bar + stack *@
    <div class="phase-stack-row">
        <PhaseBar CurrentPhase="@State.CurrentPhase"
                  CurrentCombatStep="@State.CombatStep"
                  TurnNumber="@State.TurnNumber"
                  ActivePlayerName="@State.ActivePlayer.Name"
                  HasPriority="@HasPriority"
                  IsWaitingForCombat="@IsWaitingForCombat"
                  IsWaitingForAttackers="@(IsLocalActive && Handler?.IsWaitingForAttackers == true)"
                  IsWaitingForBlockers="@(IsLocalDefending && Handler?.IsWaitingForBlockers == true)"
                  CanUndo="@(LocalPlayer.ActionHistory.Count > 0)"
                  StackCount="@State.Stack.Count"
                  StopSettings="@_phaseStops"
                  OnPass="PassPriority"
                  OnUndo="() => OnUndo.InvokeAsync()"
                  OnSurrender="() => OnSurrender.InvokeAsync()" />

        <StackDisplay Stack="@State.Stack" />
    </div>

    @* Row 4: Player battlefield *@
    <div class="player-battlefield-row">
        <PlayerZone PlayerName="@LocalPlayer.Name"
                    Battlefield="@LocalPlayer.Battlefield.Cards"
                    Hand="@LocalPlayer.Hand.Cards"
                    Graveyard="@LocalPlayer.Graveyard.Cards"
                    Life="@LocalPlayer.Life"
                    LibraryCount="@LocalPlayer.Library.Count"
                    Exile="@LocalPlayer.Exile.Cards"
                    ManaPool="@LocalPlayer.ManaPool"
                    OnLifeAdjust="(delta) => OnLifeAdjust.InvokeAsync((PlayerSeat, delta))"
                    OnDrawCard="() => OnDrawCard.InvokeAsync(PlayerSeat)"
                    IsOpponent="false"
                    IsActivePlayer="@(State.ActivePlayer == LocalPlayer)"
                    CanAct="@HasPriority"
                    PlayerId="@LocalPlayer.Id"
                    OnAction="OnAction"
                    IsWaitingForManaColor="@IsWaitingForManaColor"
                    ManaColorOptions="@ManaColorOptions"
                    OnManaColorChosen="HandleManaColorChosen"
                    IsWaitingForTarget="@(Handler?.IsWaitingForTarget == true)"
                    TargetingSpellName="@Handler?.TargetingSpellName"
                    EligibleTargets="@Handler?.EligibleTargets"
                    OnTargetSelected="HandleTargetSelected"
                    OpponentId="@OpponentPlayer.Id"
                    IsWaitingForAttackers="@(IsLocalActive && Handler?.IsWaitingForAttackers == true)"
                    EligibleAttackers="@(IsLocalActive ? Handler?.EligibleAttackers : null)"
                    OnAttackersChosen="OnAttackersChosen"
                    CombatState="@State.Combat"
                    IsWaitingForBlockers="@(IsLocalDefending && Handler?.IsWaitingForBlockers == true)"
                    EligibleBlockers="@(IsLocalDefending ? Handler?.EligibleBlockers : null)"
                    CurrentAttackers="@(IsLocalDefending ? Handler?.CurrentAttackers : null)"
                    OnBlockersChosen="OnBlockersChosen"
                    IsWaitingForBlockerOrder="@(IsLocalActive && Handler?.IsWaitingForBlockerOrder == true)"
                    OrderingAttackerId="@(Handler?.OrderingAttackerId)"
                    BlockersToOrder="@(IsLocalActive ? Handler?.BlockersToOrder : null)"
                    OnBlockerOrderChosen="OnBlockerOrderChosen"
                    IsWaitingForCardChoice="@IsWaitingForCardChoice"
                    CardChoiceOptions="@(Handler?.CardChoiceOptions)"
                    CardChoicePrompt="@(Handler?.CardChoicePrompt)"
                    CardChoiceOptional="@(Handler?.CardChoiceOptional ?? false)"
                    OnCardChosen="OnCardChosen"
                    IsWaitingForRevealAck="@IsWaitingForRevealAck"
                    RevealedCards="@(Handler?.RevealedCards)"
                    KeptCards="@(Handler?.KeptCards)"
                    RevealPrompt="@(Handler?.RevealPrompt)"
                    OnRevealAcknowledged="OnRevealAcknowledged" />
    </div>

    @* Log toggle button *@
    <MudIconButton Icon="@Icons.Material.Filled.Article" Size="Size.Small"
                   Class="log-toggle-btn" OnClick="ToggleLog" Title="Toggle Game Log" />

    @* Log overlay *@
    @if (_showLog)
    {
        <div class="log-overlay" @onclick="ToggleLog">
            <div class="log-panel" @onclick:stopPropagation>
                <GameLogPanel GameLog="@State.GameLog" />
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public GameState State { get; set; } = default!;
    [Parameter] public int PlayerSeat { get; set; }
    [Parameter] public InteractiveDecisionHandler? Handler { get; set; }
    [Parameter] public EventCallback<GameAction> OnAction { get; set; }
    [Parameter] public EventCallback OnSurrender { get; set; }
    [Parameter] public EventCallback OnUndo { get; set; }
    [Parameter] public EventCallback<(int seat, int delta)> OnLifeAdjust { get; set; }
    [Parameter] public EventCallback<int> OnDrawCard { get; set; }
    [Parameter] public bool IsGameOver { get; set; }
    [Parameter] public string? Winner { get; set; }
    [Parameter] public EventCallback<ManaColor> OnManaColorChosen { get; set; }
    [Parameter] public EventCallback<IReadOnlyList<Guid>> OnAttackersChosen { get; set; }
    [Parameter] public EventCallback<Dictionary<Guid, Guid>> OnBlockersChosen { get; set; }
    [Parameter] public EventCallback<IReadOnlyList<Guid>> OnBlockerOrderChosen { get; set; }
    [Parameter] public EventCallback<Guid?> OnCardChosen { get; set; }
    [Parameter] public EventCallback OnRevealAcknowledged { get; set; }

    private ElementReference _boardRef;
    private PhaseStopSettings _phaseStops = new();
    private bool _showLog = false;

    private Player LocalPlayer => PlayerSeat == 1 ? State.Player1 : State.Player2;
    private Player OpponentPlayer => PlayerSeat == 1 ? State.Player2 : State.Player1;
    private int OpponentSeat => PlayerSeat == 1 ? 2 : 1;
    private bool HasPriority => Handler?.IsWaitingForAction == true;
    private bool IsWaitingForManaColor => Handler?.IsWaitingForManaColor == true;
    private IReadOnlyList<ManaColor>? ManaColorOptions => Handler?.ManaColorOptions;
    private bool IsLocalActive => State.ActivePlayer == LocalPlayer;
    private bool IsLocalDefending => State.ActivePlayer == OpponentPlayer;
    private bool IsWaitingForCombat =>
        Handler?.IsWaitingForAttackers == true ||
        Handler?.IsWaitingForBlockers == true ||
        Handler?.IsWaitingForBlockerOrder == true;
    private bool IsWaitingForCardChoice => Handler?.IsWaitingForCardChoice == true;
    private bool IsWaitingForRevealAck => Handler?.IsWaitingForRevealAck == true;

    private void ToggleLog() => _showLog = !_showLog;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _boardRef.FocusAsync();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.CtrlKey && e.Key == "z" && LocalPlayer.ActionHistory.Count > 0)
        {
            await OnUndo.InvokeAsync();
        }
    }

    private async Task PassPriority()
    {
        await OnAction.InvokeAsync(GameAction.Pass(LocalPlayer.Id));
    }

    private async Task HandleManaColorChosen(ManaColor color)
    {
        await OnManaColorChosen.InvokeAsync(color);
    }

    private void HandleTargetSelected(TargetInfo target)
    {
        Handler?.SubmitTarget(target);
    }

    private async Task HandleOpponentCardClick(GameCard card)
    {
        if (Handler?.IsWaitingForTarget == true)
            Handler.SubmitTarget(new TargetInfo(card.Id, OpponentPlayer.Id, ZoneType.Battlefield));
    }

    private bool IsCardBlockingAnywhere(Guid cardId) =>
        State.Combat?.Attackers.Any(a => State.Combat.GetBlockers(a).Contains(cardId)) == true;

    private static readonly (ManaColor color, string symbol)[] ManaSymbols =
    [
        (ManaColor.White, "W"), (ManaColor.Blue, "U"), (ManaColor.Black, "B"),
        (ManaColor.Red, "R"), (ManaColor.Green, "G"), (ManaColor.Colorless, "C")
    ];
}
