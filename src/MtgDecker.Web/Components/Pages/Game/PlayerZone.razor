@using MtgDecker.Engine
@using MtgDecker.Engine.Enums
@using MtgDecker.Engine.Mana
@namespace MtgDecker.Web.Components.Pages.Game

<div class="player-zone @(IsOpponent ? "opponent" : "local")">
    <div class="zone-header">
        <MudText Typo="Typo.subtitle2">@PlayerName</MudText>

        @* Life counter *@
        <div style="display: flex; align-items: center; gap: 4px; margin-left: 12px;">
            <MudIconButton Icon="@Icons.Material.Filled.Remove" Size="Size.Small"
                           OnClick="() => OnLifeAdjust.InvokeAsync(-1)" />
            @if (_editingLife)
            {
                <div @onkeydown:stopPropagation>
                    <MudTextField T="string" @bind-Value="_lifeDelta" Immediate="true"
                                  Style="width: 60px;" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  OnKeyDown="HandleLifeKeyDown"
                                  AutoFocus="true" />
                </div>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Error"
                         Style="cursor: pointer; min-width: 40px; justify-content: center;"
                         OnClick="StartEditLife">@Life</MudChip>
            }
            <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small"
                           OnClick="() => OnLifeAdjust.InvokeAsync(1)" />
        </div>

        @if (IsActivePlayer)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Primary">Active</MudChip>
        }

        <MudText Typo="Typo.caption" Class="ml-2" Style="opacity: 0.7;">
            Library: @LibraryCount
        </MudText>
        <MudIconButton Icon="@Icons.Material.Filled.PostAdd" Size="Size.Small"
                       Title="Draw a card"
                       Disabled="@(LibraryCount == 0)"
                       OnClick="() => OnDrawCard.InvokeAsync()" />
        @if (ManaPool != null && ManaPool.Total > 0)
        {
            <div class="mana-pool-display">
                @foreach (var (color, symbol) in ManaOrder)
                {
                    @if (ManaPool[color] > 0)
                    {
                        <span class="mana-entry">
                            <img src="https://svgs.scryfall.io/card-symbols/@(symbol).svg"
                                 alt="@color" class="mana-symbol" />
                            <span class="mana-count">@ManaPool[color]</span>
                        </span>
                    }
                }
            </div>
        }
    </div>

    @* Battlefield *@
    <div class="zone battlefield">
        @foreach (var card in Battlefield)
        {
            <div style="position: relative; display: inline-block;">
                <CardDisplay Name="@card.Name"
                             ImageUrl="@card.ImageUrl"
                             Tapped="@card.IsTapped"
                             Selected="@(SelectedCard?.Id == card.Id)"
                             OnClick="() => SelectCard(card, ZoneType.Battlefield)" />
            </div>
        }
        @if (Battlefield.Count == 0)
        {
            <MudText Typo="Typo.caption" Class="empty-zone">Battlefield</MudText>
        }
    </div>

    @* Hand *@
    <div class="zone hand">
        @if (IsOpponent)
        {
            @for (int i = 0; i < Hand.Count; i++)
            {
                var index = i;
                <CardDisplay Name="Card" IsBack="true" Clickable="@CanAct"
                             OnClick="() => SelectCard(Hand[index], ZoneType.Hand)" />
            }
        }
        else
        {
            @foreach (var card in Hand)
            {
                <CardDisplay Name="@card.Name"
                             ImageUrl="@card.ImageUrl"
                             Selected="@(SelectedCard?.Id == card.Id)"
                             OnClick="() => SelectCard(card, ZoneType.Hand)" />
            }
        }
        @if (Hand.Count == 0)
        {
            <MudText Typo="Typo.caption" Class="empty-zone">Hand (empty)</MudText>
        }
        else if (IsOpponent)
        {
            <MudText Typo="Typo.caption" Class="ml-2">@Hand.Count cards</MudText>
        }
    </div>

    @* Graveyard *@
    <div class="zone graveyard">
        <MudText Typo="Typo.caption">Graveyard (@Graveyard.Count)</MudText>
        @if (Graveyard.Count > 0)
        {
            <CardDisplay Name="@Graveyard[^1].Name"
                         ImageUrl="@Graveyard[^1].ImageUrl"
                         Selected="@(SelectedCard?.Id == Graveyard[^1].Id)"
                         OnClick="() => SelectCard(Graveyard[^1], ZoneType.Graveyard)" />
        }
    </div>

    @* Exile *@
    <div class="zone exile">
        <MudText Typo="Typo.caption">Exile (@Exile.Count)</MudText>
        @if (Exile.Count > 0)
        {
            <CardDisplay Name="@Exile[^1].Name"
                         ImageUrl="@Exile[^1].ImageUrl"
                         Selected="@(SelectedCard?.Id == Exile[^1].Id)"
                         OnClick="() => SelectCard(Exile[^1], ZoneType.Exile)" />
        }
    </div>

    @* Action Menu â€” positioned relative to selected card's zone *@
    @if (SelectedCard != null)
    {
        <div style="position: relative; display: inline-block;">
            <ActionMenu Visible="true"
                        CardName="@SelectedCard.Name"
                        CurrentZone="_selectedZone"
                        IsOwnCard="@(!IsOpponent)"
                        IsTapped="@SelectedCard.IsTapped"
                        OnPlay="HandlePlay"
                        OnTapToggle="HandleTapToggle"
                        OnMoveTo="HandleMoveTo"
                        OnClose="ClearSelection" />
        </div>
    }
</div>

@code {
    [Parameter] public string PlayerName { get; set; } = "";
    [Parameter] public IReadOnlyList<GameCard> Battlefield { get; set; } = Array.Empty<GameCard>();
    [Parameter] public IReadOnlyList<GameCard> Hand { get; set; } = Array.Empty<GameCard>();
    [Parameter] public IReadOnlyList<GameCard> Graveyard { get; set; } = Array.Empty<GameCard>();
    [Parameter] public int Life { get; set; }
    [Parameter] public int LibraryCount { get; set; }
    [Parameter] public IReadOnlyList<GameCard> Exile { get; set; } = Array.Empty<GameCard>();
    [Parameter] public EventCallback<int> OnLifeAdjust { get; set; }
    [Parameter] public EventCallback OnDrawCard { get; set; }
    [Parameter] public bool IsOpponent { get; set; }
    [Parameter] public bool IsActivePlayer { get; set; }
    [Parameter] public bool CanAct { get; set; }
    [Parameter] public Guid PlayerId { get; set; }
    [Parameter] public EventCallback<GameAction> OnAction { get; set; }
    [Parameter] public ManaPool? ManaPool { get; set; }

    private GameCard? SelectedCard;
    private ZoneType _selectedZone;
    private bool _editingLife;
    private string _lifeDelta = "";

    private void SelectCard(GameCard card, ZoneType zone)
    {
        if (!CanAct && !IsOpponent) return;
        if (SelectedCard?.Id == card.Id)
        {
            ClearSelection();
            return;
        }
        SelectedCard = card;
        _selectedZone = zone;
    }

    private async Task HandlePlay()
    {
        if (SelectedCard == null) return;
        await OnAction.InvokeAsync(GameAction.PlayCard(PlayerId, SelectedCard.Id));
        ClearSelection();
    }

    private async Task HandleTapToggle()
    {
        if (SelectedCard == null) return;
        var action = SelectedCard.IsTapped
            ? GameAction.UntapCard(PlayerId, SelectedCard.Id)
            : GameAction.TapCard(PlayerId, SelectedCard.Id);
        await OnAction.InvokeAsync(action);
        ClearSelection();
    }

    private async Task HandleMoveTo(ZoneType destination)
    {
        if (SelectedCard == null) return;
        await OnAction.InvokeAsync(
            GameAction.MoveCard(PlayerId, SelectedCard.Id, _selectedZone, destination));
        ClearSelection();
    }

    private void StartEditLife()
    {
        _editingLife = true;
        _lifeDelta = "";
    }

    private async Task HandleLifeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            if (int.TryParse(_lifeDelta, out var delta))
            {
                await OnLifeAdjust.InvokeAsync(delta);
            }
            _editingLife = false;
        }
        else if (e.Key == "Escape")
        {
            _editingLife = false;
        }
    }

    private void ClearSelection()
    {
        SelectedCard = null;
    }

    private static readonly (ManaColor color, string symbol)[] ManaOrder = new[]
    {
        (ManaColor.White, "W"),
        (ManaColor.Blue, "U"),
        (ManaColor.Black, "B"),
        (ManaColor.Red, "R"),
        (ManaColor.Green, "G"),
        (ManaColor.Colorless, "C")
    };
}
