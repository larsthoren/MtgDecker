@using MtgDecker.Engine
@namespace MtgDecker.Web.Components.Pages.Game

@if (Stack.Count > 0)
{
    <div class="stack-floating-box">
        <div class="stack-header">
            <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small" />
            <span>The Stack (@Stack.Count)</span>
        </div>
        <div class="stack-cards">
            @for (int i = Stack.Count - 1; i >= 0; i--)
            {
                var item = Stack[i];
                var isTop = i == Stack.Count - 1;

                @if (item is StackObject spell)
                {
                    <div class="stack-card-entry @(IsTargeting ? "stack-targetable" : "")"
                         @onclick="() => HandleStackClick(spell.Card)">
                        <CardDisplay Name="@spell.Card.Name"
                                     ImageUrl="@spell.Card.ImageUrl"
                                     CardSize="100"
                                     Clickable="@IsTargeting"
                                     Power="@spell.Card.Power"
                                     Toughness="@spell.Card.Toughness" />
                        @if (spell.Targets.Count > 0)
                        {
                            <div class="stack-target-badge">targeted</div>
                        }
                        @if (isTop)
                        {
                            <div class="stack-resolving-badge">resolves next</div>
                        }
                    </div>
                }
                else if (item is TriggeredAbilityStackObject triggered)
                {
                    <div class="stack-card-entry @(IsTargeting ? "stack-targetable" : "")"
                         @onclick="() => HandleStackClick(triggered.Source)">
                        <CardDisplay Name="@triggered.Source.Name"
                                     ImageUrl="@triggered.Source.ImageUrl"
                                     CardSize="100"
                                     Clickable="@IsTargeting" />
                        <div class="stack-trigger-badge">trigger</div>
                        @if (isTop)
                        {
                            <div class="stack-resolving-badge">resolves next</div>
                        }
                    </div>
                }
            }
        </div>
    </div>
}

@code {
    [Parameter] public List<IStackObject> Stack { get; set; } = new();
    [Parameter] public bool IsTargeting { get; set; }
    [Parameter] public EventCallback<GameCard> OnStackCardClicked { get; set; }

    private async Task HandleStackClick(GameCard card)
    {
        if (IsTargeting)
            await OnStackCardClicked.InvokeAsync(card);
    }
}
