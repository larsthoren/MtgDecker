@page "/game/new"
@page "/game/join/{GameId}"
@rendermode InteractiveServer
@using MtgDecker.Engine
@using MtgDecker.Domain.Entities
@inject GameSessionManager SessionManager
@inject IMediator Mediator
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Play Game - MtgDecker</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Play Game</MudText>

    @if (_errorMessage != null)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
    }

    @if (_gameId == null)
    {
        @* Create or Join *@
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Create New Game</MudText>
                    <MudSelect T="MtgDecker.Domain.Enums.Format?" Label="Format" Value="_selectedFormat" ValueChanged="OnFormatChanged" Class="mb-3">
                        @foreach (var fmt in Enum.GetValues<MtgDecker.Domain.Enums.Format>())
                        {
                            <MudSelectItem T="MtgDecker.Domain.Enums.Format?" Value="@fmt">@fmt</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="Guid?" Label="Select Your Deck" @bind-Value="_selectedDeckId" Class="mb-3"
                               Disabled="@(_selectedFormat == null)">
                        @foreach (var deck in FilteredDecks)
                        {
                            <MudSelectItem T="Guid?" Value="@deck.Id">@deck.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudTextField @bind-Value="_playerName" Label="Your Name" Class="mb-3" />
                    <MudCheckBox T="bool" @bind-Value="_playVsAi" Label="Play vs AI" Color="Color.Secondary" Class="mb-3" />
                    @if (_playVsAi)
                    {
                        <MudSelect T="Guid?" Label="AI Deck" @bind-Value="_aiDeckId" Class="mb-3"
                                   Disabled="@(_selectedFormat == null)">
                            @foreach (var deck in FilteredDecks)
                            {
                                <MudSelectItem T="Guid?" Value="@deck.Id">@deck.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                               Disabled="@(IsCreateDisabled)"
                               OnClick="CreateGame">@(_playVsAi ? "Start Game" : "Create Game")</MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Join Existing Game</MudText>
                    <MudTextField @bind-Value="_joinGameId" Label="Game Code" Class="mb-3"
                                  TextChanged="OnJoinGameIdChanged" />
                    @if (_joinFormat != null)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">Format: @_joinFormat</MudAlert>
                    }
                    <MudSelect T="Guid?" Label="Select Your Deck" @bind-Value="_joinDeckId" Class="mb-3">
                        @foreach (var deck in JoinFilteredDecks)
                        {
                            <MudSelectItem T="Guid?" Value="@deck.Id">@deck.Name (@deck.Format)</MudSelectItem>
                        }
                    </MudSelect>
                    <MudTextField @bind-Value="_joinPlayerName" Label="Your Name" Class="mb-3" />
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth="true"
                               Disabled="@(string.IsNullOrWhiteSpace(_joinGameId) || _joinDeckId == null || string.IsNullOrWhiteSpace(_joinPlayerName))"
                               OnClick="JoinGame">Join Game</MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else
    {
        @* Waiting for opponent *@
        <MudPaper Class="pa-6 text-center">
            <MudText Typo="Typo.h5" Class="mb-2">Game Created!</MudText>
            <MudText Typo="Typo.body1" Class="mb-4">Share this code with your opponent:</MudText>
            <MudText Typo="Typo.h3" Color="Color.Secondary" Class="mb-4"
                     Style="font-family: monospace; letter-spacing: 8px;">@_gameId</MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                Or share this link:
                <MudLink Href="@($"{Navigation.BaseUri}game/join/{_gameId}")" Target="_blank">
                    @(Navigation.BaseUri)game/join/@_gameId
                </MudLink>
            </MudText>
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
            <MudText Typo="Typo.body2" Class="mt-2">Waiting for opponent to join...</MudText>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public string? GameId { get; set; }

    private List<Deck> _decks = new();
    private MtgDecker.Domain.Enums.Format? _selectedFormat;
    private Guid? _selectedDeckId;
    private Guid? _joinDeckId;
    private string _playerName = "";
    private string _joinPlayerName = "";
    private string? _joinGameId;
    private string? _joinFormat;
    private string? _gameId;
    private string? _errorMessage;
    private int _mySeat;
    private bool _playVsAi;
    private Guid? _aiDeckId;
    private CancellationTokenSource _pollCts = new();

    private void OnFormatChanged(MtgDecker.Domain.Enums.Format? value)
    {
        _selectedFormat = value;
        _selectedDeckId = null;
        _aiDeckId = null;
    }

    private IEnumerable<Deck> FilteredDecks =>
        _selectedFormat == null ? [] : _decks.Where(d => d.Format == _selectedFormat.Value);

    private IEnumerable<Deck> JoinFilteredDecks =>
        _joinFormat == null ? _decks : _decks.Where(d => d.Format.ToString() == _joinFormat);

    private bool IsCreateDisabled =>
        _selectedFormat == null || _selectedDeckId == null || string.IsNullOrWhiteSpace(_playerName)
        || (_playVsAi && _aiDeckId == null);

    // Hardcoded UserId matching existing app pattern
    private static readonly Guid UserId = Guid.Parse("00000000-0000-0000-0000-000000000001");

    protected override async Task OnInitializedAsync()
    {
        _decks = await Mediator.Send(new MtgDecker.Application.Decks.ListDecksQuery(UserId));

        if (GameId != null)
        {
            _joinGameId = GameId;
            LookupJoinFormat(GameId);
        }
    }

    private void OnJoinGameIdChanged(string value)
    {
        _joinGameId = value;
        _joinDeckId = null;
        LookupJoinFormat(value);
    }

    private void LookupJoinFormat(string? gameId)
    {
        _joinFormat = null;
        if (string.IsNullOrWhiteSpace(gameId)) return;
        var session = SessionManager.GetSession(gameId);
        if (session != null)
        {
            _joinFormat = session.Format;
        }
    }

    private async Task CreateGame()
    {
        var deck = await LoadGameDeck(_selectedDeckId!.Value);
        if (deck == null) return;

        var session = SessionManager.CreateGame();
        session.Format = _selectedFormat?.ToString();
        var seat = session.JoinPlayer(_playerName, deck);
        _mySeat = seat;

        if (_playVsAi)
        {
            var aiDeck = await LoadGameDeck(_aiDeckId!.Value);
            if (aiDeck == null) return;

            session.IsAiOpponent = true;
            session.JoinPlayer("AI Bot", aiDeck);
            await session.StartAsync();
            Navigation.NavigateTo($"/game/{session.GameId}?seat={_mySeat}");
        }
        else
        {
            _gameId = session.GameId;
            _ = WaitForOpponentAsync(session);
        }
    }

    private async Task JoinGame()
    {
        var session = SessionManager.GetSession(_joinGameId!);
        if (session == null)
        {
            _errorMessage = "Game not found.";
            return;
        }
        if (session.IsFull)
        {
            _errorMessage = "Game is already full.";
            return;
        }

        var deck = await LoadGameDeck(_joinDeckId!.Value);
        if (deck == null) return;

        var seat = session.JoinPlayer(_joinPlayerName, deck);
        Navigation.NavigateTo($"/game/{session.GameId}?seat={seat}");
    }

    private async Task WaitForOpponentAsync(GameSession session)
    {
        try
        {
            while (!session.IsFull)
            {
                await Task.Delay(1000, _pollCts.Token);
            }
            await InvokeAsync(() => Navigation.NavigateTo($"/game/{session.GameId}?seat={_mySeat}"));
        }
        catch (OperationCanceledException) { }
    }

    public void Dispose()
    {
        _pollCts.Cancel();
        _pollCts.Dispose();
    }

    private async Task<List<GameCard>?> LoadGameDeck(Guid deckId)
    {
        var deck = await Mediator.Send(new MtgDecker.Application.Decks.GetDeckQuery(deckId));
        if (deck == null)
        {
            _errorMessage = "Deck not found.";
            return null;
        }

        var cardIds = deck.Entries.Select(e => e.CardId).Distinct().ToList();
        var cards = await Mediator.Send(new MtgDecker.Application.Cards.GetCardsByIdsQuery(cardIds));
        var cardMap = cards.ToDictionary(c => c.Id);

        var gameCards = new List<GameCard>();
        foreach (var entry in deck.Entries.Where(e => e.Category == MtgDecker.Domain.Enums.DeckCategory.MainDeck))
        {
            if (!cardMap.TryGetValue(entry.CardId, out var card)) continue;
            for (int i = 0; i < entry.Quantity; i++)
            {
                gameCards.Add(GameCard.Create(card.Name, card.TypeLine,
                    card.ImageUriSmall ?? card.ImageUri,
                    card.ManaCost, card.Power, card.Toughness));
            }
        }

        return gameCards;
    }
}
